name: docker_build
on: [push]
jobs:
  build:
    environment: datadog
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo content
        uses: actions/checkout@v2
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: install dependencies
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          curl -LO "https://dl.k8s.io/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          pip install datadog-api-client
          pip install pyyaml
          pip install kubernetes
          pip install gitpython
          pip install python_terraform

      #- name: build and push image
        #env:
        #  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        #run: |
        #  pushd kubernetes/nodejs_tracing/dockerfile_configuration/
        #  echo $DOCKER_PASSWORD > docker.txt
        #  cat docker.txt | docker login --username jenksgibbons --password-stdin
        #  cp dockerfile app/
        #  pushd app/
        #  cat package.json
        #  docker build -t jenksgibbons/knote .;docker push jenksgibbons/knote
        shell: bash
      - name: configure ci
        env:
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DD_CLUSTER_AGENT_AUTH_TOKEN: ${{ secrets.DATADOG_API_KEY }}
        run: |
          pushd kubernetes/kind
          curl -O https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrole.yaml
          curl -O https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/serviceaccount.yaml
          curl -O https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrolebinding.yaml
          echo "# kind: Deployment" >> clusterrole.yaml
          echo "# kind: Deployment" >> serviceaccount.yaml
          echo "# kind: Deployment" >> clusterrolebinding.yaml
          popd
          sed -i 's/dd-rum-tokens/datadog-agent-cluster-agent/' kubernetes/cicd/dev/config.yaml
          sed -i 's/\"APPLICATION_ID\"/token/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<APPLICATION_ID>/${{ secrets.DD_CLUSTER_TOKEN }}/' kubernetes/cicd/dev/config.yaml
          sed -i 's/      secret_key_1: \"CLIENT_TOKEN\"/  - generic:\n      name: datadog-agent\n      secret_key_1: api-key\n      value_1: ${{ secrets.DATADOG_API_KEY }}/' kubernetes/cicd/dev/config.yaml
          sed -i 's/value_1: <CLIENT_TOKEN>//' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_1>/\"..\/..\/kubernetes\/daemonset\/all_features\/datadog-agent-all-features.yaml"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<NAMESPACE>/\"default\"/g' kubernetes/cicd/dev/config.yaml
          sed -i 's/<LABEL_SELECTOR_1>/\"app=datadog-agent\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_2>/\"..\/..\/kubernetes\/nodejs_tracing\/dockerfile_configuration\/knote.yaml\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<LABEL_SELECTOR_2>/\"app=knote\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_3>/\"..\/..\/kubernetes\/nodejs_tracing\/dockerfile_configuration\/mongo.yaml\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/label_selector: \"\"/label_selector: \"app=mongo\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<BROWSER_TEST_PUBLIC_ID>/\"476-sd6-bh6\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/False/True/' kubernetes/cicd/dev/config.yaml
          sed -i 's/kubernetes\/kind/..\/..\/kind/' kubernetes/cicd/dev/config.yaml
          sed -i 's/application:/application:\n  - object:\n      manifest: \".\/clusterrole.yaml\"\n      namespace: \"\"\n      label_selector: \"\"\n  - object:\n      manifest: \".\/serviceaccount.yaml\"\n      namespace: \"\"\n      label_selector: \"\"\n  - object:\n      manifest: \".\/clusterrolebinding.yaml\"\n      namespace: \"\"\n      label_selector: \"\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<repo>\/<image>/jenksgibbons\/knote/' kubernetes/nodejs_tracing/dockerfile_configuration/knote.yaml
          sed -i 's/<ip>/127.0.0.1/' kubernetes/nodejs_tracing/dockerfile_configuration/knote.yaml
          sed -i 's/<//g' kubernetes/cicd/dev/config.yaml
          sed -i 's/>//g' kubernetes/cicd/dev/config.yaml
          sed -i 's/PORT_FORWARD_TYPE_NAME/deploy\/knote/' kubernetes/cicd/dev/config.yaml
          sed -i 's/BROWSER_TEST_APP_PORT/80/' kubernetes/cicd/dev/config.yaml
          sed -i 's/BROWSER_TEST_TUNNEL_PORT/33333/' kubernetes/cicd/dev/config.yaml
          cat kubernetes/cicd/dev/config.yaml
          pushd kubernetes/cicd/dev/
      - name: run ci
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DATADOG_APP_KEY: ${{ secrets.DATADOG_APP_KEY }}
          DD_CLUSTER_AGENT_AUTH_TOKEN: ${{ secrets.DD_CLUSTER_AGENT_AUTH_TOKEN }}
        run: |
          pushd kubernetes/cicd/dev/
          python3 dev.py
          kubectl --kubeconfig=../../kind/config describe pods
          kubectl --kubeconfig=../../kind/config get secrets
          popd
          sleep 20
        shell: bash


