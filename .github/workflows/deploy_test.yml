name: deploy_test
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo content
        uses: actions/checkout@v2 # checkout the repository content to github runner.
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8 #install the python needed
      - name: install libraries
        run: |
          pip install datadog-api-client
          pip install pyyaml
          pip install requests
          pip install gitpython
          pip install kubernetes
          pip install python_terraform
      - name: configure ci
        run: |
          sed -i 's/<APPLICATION_ID>/\"${{ secrets.APPLICATION_ID }}\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<CLIENT_TOKEN>/\"${{ secrets.CLIENT_TOKEN }}\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_1>/\"app-java\/kubernetes\/app-java.yaml\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<NAMESPACE>/\"default\"/g' kubernetes/cicd/dev/config.yaml
          sed -i 's/<LABEL_SELECTOR_1>/\"run=app-java\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_2>/\"app-java\/kubernetes\/mysql_ja.yaml\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<LABEL_SELECTOR_2>/\"run=mysql\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<MANIFEST_3>/\"app-java\/kubernetes\/app_java_service.yaml\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<BROWSER_TEST_PUBLIC_ID>/\"476-sd6-bh6\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<BROWSER_TEST_TUNNEL_PORT>/33333/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<BROWSER_TEST_APP_PORT>/8080/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<PORT_FORWARD_TYPE_NAME>/\"deploy\/app-java\"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/<SERVICE_NAME>/"app-java"/' kubernetes/cicd/dev/config.yaml
          sed -i 's/.\/config/kubernetes\/cicd\/dev\/config.yaml/' kubernetes/cicd/dev/config.yaml
          sed -i 's/\/kubernetes\/kind/..\/..\/kind/' kubernetes/cicd/dev/config.yaml
      - name: run ci
        run: |
          pushd kubernetes/cicd/dev/
          echo "ls .."
          ls ..
          python dev.py
        shell: bash
      #- name: execute py script
      #  run: |
      #    import os
      #    print(os.environ['PATH'])
      #  shell: python
      #- name: execute py script # run the run.py to get the latest data
      #  run: |
      #    python run.py
      #  env:
      #    key: ${{ secrets.key }} # if run.py requires passwords..etc, set it as secrets
      #- name: export index
      #  .... # use crosponding script or actions to help export.
